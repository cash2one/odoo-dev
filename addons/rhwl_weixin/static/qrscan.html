<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>样品发货</title>

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit">
  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <link rel="icon" type="image/png" href="assets/i/favicon.png">
  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="assets/i/app-icon72x72@2x.png">
  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI"/>
  <link rel="apple-touch-icon-precomposed" href="assets/i/app-icon72x72@2x.png">
  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="assets/i/app-icon72x72@2x.png">
  <meta name="msapplication-TileColor" content="#0e90d2">
  <link rel="stylesheet" href="assets/css/amazeui.min.css">
  <link rel="stylesheet" href="assets/css/app.css">
</head>
<body>
<div class="am-u-sm-centered am-u-md-centered am-u-lg-centered">
    <div class="am-input-group am-form-field" >
        <input id="scantext" type="text" class="am-input-lg " placeholder="快递单号" />
        <button id="scanbtn" class="am-btn am-btn-primary am-round am-btn-xs am-disabled">扫描快递单号</button>
    </div>
    <div class="am-form-field">
        <table id="lists" class="am-table am-table-striped am-table-hover">
            <thead>
                <tr>
                    <td>新样品代号</td>
                    <td>原样品代号</td>
                    <td> </td>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <div class="am-form-field am-u-sm-centered am-u-md-centered am-u-lg-centered">
        <button id="btn_add" class="am-btn am-btn-warning am-round am-disabled">添加样品</button>
        <button id="btn_submit" class="am-btn  am-btn-success am-round ">提交快递单</button>
    </div>
 </div>
<div class="am-modal am-modal-no-btn am-animation-slide-right" tabindex="-1" id="doc-modal-1">
  <div class="am-modal-dialog">
    <div class="am-modal-hd am-topbar-inverse">需重采血样品
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close><h3 style="font-size:200%">&times;</h3></a>
    </div>

    <div class="am-modal-bd">
        <table id="reuse" class="am-table am-table-striped am-table-hover">
            <thead>
                <tr>
                    <td>样品编码</td>
                    <td>姓名</td>
                    <td>采血时间</td>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
     </div>
  </div>
</div>
<!--在这里编写你的代码-->
<!--[if (gte IE 9)|!(IE)]><!-->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/amazeui.min.js"></script>
<!--<![endif]-->
<!--[if lte IE 8 ]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<![endif]-->
<script src="/rhwl_weixin/static/js/weixin.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
     var store = $.AMUI.store;
  $(function() {
    //$('#tab').find('tbody').append('<tr><td>名称</td><td>网址</td><td>日期</td></tr>');
    wx.ready(function(){
        $("#scanbtn").removeClass("am-disabled");
        $("#btn_add").removeClass("am-disabled");
    });
    wx.error(function(res){
        alert("配置扫码接口失败");
    });
	$.ajax({
		  type: 'POST',
		  url: "/web/weixin/jsapi/",
		  data: {"url":location.href.split('#')[0]},
		  success: function(data){
              wx.config({
                    debug: false,
                    appId: data.appid,
                    timestamp: data.timestamp,
                    nonceStr: data.noncestr,
                    signature: data.signature,
                    jsApiList: ['scanQRCode']
                });

		  },
          fail:function(res){
              alert("配置JSAPI失败");
          }
		});
    $("#lists tbody").on("click","tr",function(e){
        if(e.target.className=="am-close"&& (e.target.nodeName=="BUTTON" ||e.target.nodeName=="BUTON") ){
            $(e.currentTarget).remove();
        }else if((e.target.nodeName=="BUTTON" ||e.target.nodeName=="BUTON") && e.target.innerText=="关联"){
            $("#doc-modal-1").modal({"closeViaDimmer": 0,"relatedTarget": e.target.parentElement});
        }else if((e.target.nodeName=="BUTTON" ||e.target.nodeName=="BUTON") && e.target.innerText=="删除"){
            e.target.parentElement.innerHTML="<buton type=\"button\" class=\"am-btn-link am-btn-xs\">关联</buton>"
        }
        //
    });
    $('#doc-modal-1').bind('open.modal.amui',
        function(e){
            this.relatedTarget = e.relatedTarget;
            $("#reuse tbody tr").remove();
           $.ajax({
              type: 'POST',
              url: "/web/crmapp/reuse/?openid="+$.getUrlVar('openid'),
              data: "",
              success: function(data){
                  $.each(data,function(k,v){
                      $("#reuse tbody").append("<tr><td>"+ v.id+"</td><td>"+ v.name+"</td><td>"+ v.time+"</td></td></tr>");
                  });
              }
            });
        }
    );
    $("#reuse tbody").on("click","tr",function(e){
        var val = e.currentTarget.children[0].textContent;
        e.currentTarget.parentElement.parentElement.parentElement.parentElement.parentElement.relatedTarget.innerHTML=val+" <buton type=\"button\" class=\"am-btn-link am-btn-xs\">删除</buton>";
        $('#doc-modal-1').modal("close");
    });
    $("#scanbtn").bind("click",function(e){
        scan(set_text,false);
    });
    $("#btn_add").bind("click",function(e){
        while(1>0){
            var r=scan(set_lists,true);
            if(!r || r==undefined){
                break;
            };
        }
    });
    $("#btn_submit").bind("click",function(e){
       //快递单提交处理
        var no = $("#scantext").val();
        var lists=$("#lists tbody").children();
        if($.trim(no)==""){
            alert("快递单号码不能为空。");
            return false;
        }
        if(lists.length==0){
            alert("发送样品个数不为空。");
            return false;
        }
        var demo={
            packageID:no,
            demo:new Array()
        }
        $("#lists tbody tr").each(function(i){
            var tmp={code:"",preCode:""};
            $(this).children("td").each(function(i){
                if(i==0){
                    tmp.code=$(this).text();
                }else if(i==1&&$(this).text().indexOf(" ")>0){
                    tmp.preCode=$(this).text().split(" ")[0];
                }
            });
            demo.demo[i]=tmp;
        });
        //alert(JSON.stringify(demos));
        $.ajax({
              type: 'POST',
              url: "/web/crmapp/deliver/?openid="+$.getUrlVar('openid'),
              data: {packageID:demo.packageID,demos:JSON.stringify(demo.demo)},
              success: function(data){
                  alert("单据提交成功。");
                  location.reload();
              },
              fail:function(res){
                  alert("单据提交失败。");
              }
            });
    });
    //设置快递单扫码结果
    function set_text(t){
        $("#scantext").val(t.split(",")[1]);
    }
    //设置样品扫码结果
    function set_lists(t){
        var lst = store.get('lists');
        if(lst==undefined){
            lst=new Array();
        }

        lst = lst.concat(new Array({first:t.split(",")[1],second:""}));
        store.set('lists',lst);
        $("#lists tbody").append("<tr><td>"+ t.split(",")[1]+"</td><td><buton type=\"button\" class=\"am-btn-link am-btn-xs\">关联</buton><td><button type=\"button\" class=\"am-close\">&times;</button></td></tr>");
    }
    //根据本地存储初始化列表内容
    function init_lists(){
         lst = store.get('lists');
        if(lst==undefined){
            lst=new Array();
        }

        for(i=0;i<lst.length;i++){
            if (lst[i].second==undefined){
                $("#lists tbody").append("<tr><td>"+ lst[i].first+"</td><td><buton type=\"button\" class=\"am-btn-link am-btn-xs\">关联</buton></td><td><button type=\"button\" class=\"am-close\">&times;</button></td></tr>");
            }else{
                $("#lists tbody").append("<tr><td>"+ lst[i].first+"</td><td>"+lst[i].second+" <buton type=\"button\" class=\"am-btn-link am-btn-xs\">删除</buton></td><td><button type=\"button\" class=\"am-close\">&times;</button></td></tr>");
            }
        }
    }

    function scan(f,is_continue){

            wx.scanQRCode({
                needResult:1,
                scanType: ["barCode"], // 可以指定扫二维码还是一维码
                success: function (res) {
                            var result = res.resultStr; // 当needResult 为 1 时，扫码返回的结果
                            if(result==undefined){
                                return false;
                            }else{
                                f(result);
                                return is_continue;
                            }
                         },
                fail:function(res){
                    return false;
                    }
            });
    }
    //init_lists();
  });
</script>
</body>
</html>