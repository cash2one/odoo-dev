<!doctype html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>运营物料申请</title>

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit">
  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>
  <link rel="icon" type="image/png" href="/rhwl_weixin/static/assets/i/favicon.png">
  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="/rhwl_weixin/static/assets/i/app-icon72x72@2x.png">
  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Amaze UI"/>
  <link rel="apple-touch-icon-precomposed" href="/rhwl_weixin/static/assets/i/app-icon72x72@2x.png">
  <!-- Tile icon for Win8 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="/rhwl_weixin/static/assets/i/app-icon72x72@2x.png">
  <meta name="msapplication-TileColor" content="#0e90d2">
  <link rel="stylesheet" href="http://cdn.amazeui.org/amazeui/2.4.2/css/amazeui.min.css">

</head>
<body>
<div class="am-u-sm-centered am-u-md-centered am-u-lg-centered">
    <form class="am-form">
        <div class="am-form-group">
            <label class="am-form-label" for="wh_level">库存级别</label><br>
            <select id="wh_level" class="am-form-field" data-am-selected="{btnWidth: '100%'}">
                <option value="person" selected="selected">销售员级</option>
                <option value="hospital">医院级</option>
                <option value="proxy">代理级</option>
            </select>
        </div>

        <div class="am-form-group am-hide" id="hospital">
            <label class="am-form-label" for="partner_id">申请机构</label><br>
            <select id="partner_id" class="am-form-field" data-am-selected="{btnWidth: '100%',searchBox: 1}">

            </select>
        </div>

        <div class="am-form-group" id="address">
            <label class="am-form-label">收货地址</label><br>
        </div>

        <div class="am-form-group  am-hide">
            <label for="doc-ipt-3" class="am-form-label">收件人</label>

              <input type="text" id="doc-ipt-3">

        </div>
        <div class="am-form-group  am-hide">
            <label for="doc-ipt-4" class="am-form-label">收件人地址</label>

              <input type="text" id="doc-ipt-4" >

        </div>
        <div class="am-form-group  am-hide">
            <label for="doc-ipt-5" class="am-form-label">收件人电话</label>

              <input type="text" id="doc-ipt-5">

        </div>
    </form>

    <table id="tab" data-id="0" class="am-table am-table-bordered am-table-striped am-table-compact">
        <thead>
            <tr>
                <th>物料名称</th>
                <th>单位</th>
                <th>数量</th>
                <th></th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
    <button
      type="button"
      class="am-btn am-btn-link"
      data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0}">
      点我新增
    </button>
    <br><br>
    <footer>
        <button type="button" id="form_save" class="am-btn am-btn-secondary am-btn-block" >保存草稿</button>
        <button type="button" id="form_submit" class="am-btn am-btn-success am-btn-block" >提交申请</button>
    </footer>

 </div>

<div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
  <div class="am-modal-dialog">
    <div class="am-modal-hd am-topbar-inverse">物料明细
      <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
    </div>
    <div class="am-modal-bd">
      <form class="am-form">
            <div class="am-form-group" style="text-align:left;">
                <label for="doc-ipt-15" class="am-form-label">物料名称</label>
                <select id="doc-ipt-15" class="am-form-field" data-am-selected="{btnWidth: '100%',searchBox: 1}"></select>
            </div>
            <div class="am-form-group" style="text-align:left;">
                <label for="doc-ipt-16" class="am-form-label">单位</label>
                <input type="text" id="doc-ipt-16" disabled>
            </div>
            <div class="am-form-group"  style="text-align:left;">
                <label for="doc-ipt-17" class="am-form-label">数量</label>

                <button type="button" class="am-btn" style="display:inline;" id="minus_num">-</button>
                <input type="number" id="doc-ipt-17" min="1" max="999" style="width:100px;display:inline;" value="1"/>
                <button type="button" class="am-btn" style="display:inline;" id="add_num">+</button>
            </div>
            <div class="am-form-group">
                <button type="button" id="product_add" class="am-btn am-btn-success am-btn-block" >确 定</button>
            </div>
      </form>
    </div>
  </div>
</div>

<!--在这里编写你的代码-->
<!--[if (gte IE 9)|!(IE)]><!-->
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<script src="http://cdn.amazeui.org/amazeui/2.4.2/js/amazeui.min.js"></script>
<!--<![endif]-->
<!--[if lte IE 8 ]>
<script src="http://libs.baidu.com/jquery/1.11.1/jquery.min.js"></script>
<![endif]-->
<script src="/rhwl_weixin/static/js/weixin-0.2.js"></script>

<script>
     var store = $.AMUI.store;
     function login_address(){
         $.ajax({
                  type:'POST',
                  url:"/web/api/web_material/login_address/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code'),
                  data: {},
                      success: function(data){
                          $("#address").append('<div class="am-radio"><label><input type="radio" name="doc-radio-1" value="'+data[0]+'" checked>'+data[1]+','+data[2]+','+data[3]+'</label></div>');
                      },
                      fail:function(res){
                          alert("获取当前登录用户的邮寄信息失败。");
                      }
              });
     }

     $("#product_add").bind("click",function(e){
         var v = $("#doc-ipt-15").children('option:selected');
         var is_exists=false;
         $.each($("#tab tbody").children(),function(k,vv){
            if(vv.dataset.id==v[0].value){
                $("#tab tbody").children()[k].children[2].children[1].value=$("#doc-ipt-17").val();
                is_exists=true;
            };
         });
         if(!is_exists){
             $("#tab tbody").append("<tr data-id=\""+v[0].value+"\"><td>"+v[0].label+"</td><td>"+v[0].dataset.uom+"</td><td><button type=\"button\" class=\"am-btn am-btn-xs\" style=\"display:inline;\">-</button><input type=\"number\" min=\"1\" max=\"999\" style=\"display:inline;\" value=\""+$("#doc-ipt-17").val()+"\"/><button type=\"button\" class=\"am-btn am-btn-xs\" style=\"display:inline;\">+</button></td><td><button type=\"button\" class=\"am-btn-link am-btn-xs\">删除</button></td></tr>");
         }
         $('#doc-modal-1').modal("close");
     });
     $("#tab tbody").on("click","tr",function(e){
        if(e.target.className=="am-btn-link am-btn-xs"&& (e.target.nodeName=="BUTTON" ||e.target.nodeName=="BUTON") ){
            $(e.currentTarget).remove();
        }else if(e.target.className=="am-btn am-btn-xs"&& (e.target.nodeName=="BUTTON" ||e.target.nodeName=="BUTON") ){
            if(e.target.innerText=="+"){
                var t= $(e.target.parentElement)[0].childNodes[1].value;
                $(e.target.parentElement)[0].childNodes[1].value = parseInt(t)+1
            }else{
                var t= $(e.target.parentElement)[0].childNodes[1].value;
                if(parseInt(t)>1){
                    $(e.target.parentElement)[0].childNodes[1].value = parseInt(t)-1
                }
            }
        }
    });
  $(function() {
    //$('#tab').find('tbody').append('<tr><td>名称</td><td>网址</td><td>日期</td></tr>');
      $('#wh_level').change(function() {
          var v = $(this).children('option:selected').val();
          $(".am-radio").remove();
          if(v=="person"){
              $("#hospital").addClass("am-hide");
              //获取当前登录用户的邮寄信息
              login_address();
          }else{
              $("#hospital").removeClass("am-hide");
              $("#partner_id").trigger("change");
          }
      });



    $.ajax({
              type: 'POST',
              url: "/web/api/rhwl/partner/get/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code'),
              data: {},
              success: function(data){
                  $.each(data,function(k,v){
                      if(k==0){
                          $("#partner_id").append("<option value=\""+v[0]+"\" selected>"+v[1]+"</option>");
                      }else{
                          $("#partner_id").append("<option value=\""+v[0]+"\">"+v[1]+"</option>");
                      }
                  });
                    $("#partner_id").change(function(){
                        if($("#hospital").hasClass("am-hide")){
                            return;
                        }
                          var v = $(this).children('option:selected').val();

                          $.ajax({
                              type:"POST",
                              url:"/web/api/web_material/all_address/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code')+"&partner="+v,
                              data:{},
                              success:function(data){
                                    $(".am-radio").remove();
                                  $.each(data,function(k,v){
                                      $("#address").append('<div class="am-radio"><label><input type="radio" name="doc-radio-1" value="'+v[0]+'" checked>'+v[1]+'：'+v[2]+','+v[3]+','+v[4]+'</label></div>');
                                  });
                              }
                          });
                      });
                  //判断是否为修改
                  if($.getUrlVar('id')!=undefined){
                      $.ajax({
                          type:"POST",
                          url:"/web/api/web_material/detail/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code'),
                          data:{id:$.getUrlVar('id')},
                          success:function(data){

                              $("#tab")[0].dataset.id = $.getUrlVar('id');
                              $("#wh_level option[value=\""+data[0]+"\"]").attr("selected",true);
                              if(data[0]!="person"){
                                  $("#partner_id option[value=\""+data[1]+"\"]").attr("selected",true);
                              }
                              if(data[2]!=false){
                                  $("#address input[value='"+data[2]+"']").attr("checked",true);
                              }
                              if(data[3]!="draft"){
                                  $("#form_save").addClass("am-hide");
                                    $("#form_submit").addClass("am-hide");
                                  $(".am-btn-link").addClass("am-hide");
                              }
                              $.each(data[4],function(k,v){
                                  if(data[3]!="draft"){
                                      $("#tab tbody").append("<tr data-id=\""+v[0]+"\"><td>"+v[1]+"</td><td>"+v[2]+"</td><td>"+v[3]+"</td><td></td></tr>");
                                  }else{
                                      $("#tab tbody").append("<tr data-id=\""+v[0]+"\"><td>"+v[1]+"</td><td>"+v[2]+"</td><td><button type=\"button\" class=\"am-btn am-btn-xs\" style=\"display:inline;\">-</button><input type=\"number\" min=\"1\" max=\"999\" style=\"display:inline;\" value=\""+v[3]+"\"/><button type=\"button\" class=\"am-btn am-btn-xs\" style=\"display:inline;\">+</button></td><td><button type=\"button\" class=\"am-btn-link am-btn-xs\">删除</button></td></tr>");
                                  }

                              })
                          }
                      });
                  }
              },
              fail:function(res){
                  alert("获取采血医院信息失败。");
              }
            });


      $.ajax({
              type: 'POST',
              url: "/web/api/web_material/get/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code'),
              data: {},
              success: function(data){
                  $.each(data,function(k,v){
                    $("#doc-ipt-15").append("<option value=\""+v[0]+"\" data-uom=\""+v[2]+"\">"+v[1]+"</option>");
                  });
                  $("#doc-ipt-15").change(function() {
                      var v = $(this).children('option:selected');
                      $("#doc-ipt-16").val(v[0].dataset.uom);
                  });
              },
              fail:function(res){
                  alert("获取物料信息失败。");
              }
            });

      $("#add_num").bind("click",function(e){
            var text=$("#doc-ipt-17").val();
            $("#doc-ipt-17").val(parseInt(text)+1);
      });
      $("#minus_num").bind("click",function(e){
            var text=$("#doc-ipt-17").val();
          if(parseInt(text)>0){
              $("#doc-ipt-17").val(parseInt(text)-1);
          }

      });
      function get_data(){
          var p={
              id:$("#tab")[0].dataset.id,
              wh_level:$('#wh_level').children('option:selected').val(),
              partner_id:$('#partner_id').children('option:selected').val(),
              address_id:$("#address input[name='doc-radio-1']:checked").val(),
              line:new Array()
          }

          $.each($("#tab tbody").children(),function(k,v){
              p.line[k]=[v.dataset.id,v.children[2].children[1].value]
         });
         return p;
      }

      function valid_data(p) {
          if(p.wh_level!="person" && p.partner_id==undefined){
              alert("请选择一个申请机构。");
              return false;
          }
          if(p.address_id==undefined){
              alert("请选择一个收货地址。");
              return false;
          }
          if(p.line.length==0){
              alert("申请物料不可以为空。");
              return false;
          }
          return true;
      }

      function submit_data(p){
          $.ajax({
              type: 'POST',
              url: "/web/api/web_material/post/?openid="+$.getUrlVar('openid')+"&code="+$.getUrlVar('code'),
              data: {p:JSON.stringify(p)},
              success: function(data){
                  $("#tab")[0].dataset.id = data[0];
                  if(p.is_confirm=="1"){
                      $("#form_save").addClass("am-hide");
                      $("#form_submit").addClass("am-hide");
                      alert("申请单提交成功。");
                      location.reload();
                  }else{
                      alert("申请单已保存至草稿。")
                  }
              },
              fail:function(res){
                  alert("单据保存失败。");
              }
            });
      }

      $("#form_save").bind("click",function(e){
          var p = get_data();
          if(valid_data(p)){
              p.is_confirm="0";
              submit_data(p);
          }
      });
      $("#form_submit").bind("click",function(e){
          var p = get_data();
          if(valid_data(p)){
              p.is_confirm="1";
              submit_data(p);

          }
      });
      login_address();
      //$('#wh_level').trigger("change");
  });
</script>
</body>
</html>