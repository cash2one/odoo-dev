# -*- coding: utf-8 -*-

from openerp import http
from openerp.http import request
from openerp.addons.base.res.res_users import res_users
import json,simplejson
import openerp.tools.config as config
import openerp
from openerp import SUPERUSER_ID
from openerp.modules.registry import RegistryManager
import openerp.addons.web.controllers.main as db
import datetime
import logging
from openerp.tools.translate import _
from lxml import etree

_logger = logging.getLogger(__name__)

bank_name={
    '01000000':u'邮储银行',
'01020000':u'工商银行',
'01030000':u'农业银行',
'01033320':u'宁波市农业银行',
'01040000':u'中国银行',
'01050000':u'建设银行',
'01059999':u'中国建设银行',
'03010000':u'交通银行',
'03020000':u'中信银行',
'03030000':u'光大银行',
'03040000':u'华夏银行',
'03050000':u'民生银行',
'03060000':u'广东发展银行',
'03070000':u'深圳发展银行',
'03080000':u'招商银行',
'03090000':u'兴业银行',
'03100000':u'浦东发展银行',
'03114560':u'恒丰银行',
'03131100':u'天津市商业银行',
'03133930':u'厦门市商业银行',
'03134500':u'济南商业银行',
'03134530':u'淄博商业银行',
'03134560':u'烟台商业银行',
'03134580':u'潍坊商业银行',
'03134730':u'临沂商业银行',
'03134732':u'日照市商业银行',
'03160000':u'浙商银行',
'03170000':u'渤海银行',
'03190001':u'花旗银行(中国)有限公司',
'03200000':u'东亚银行中国有限公司',
'03210000':u'汇丰银(中国)有限公司',
'03220000':u'渣打银行中国有限公司',
'03240000':u'星展银行',
'03260000':u'恒生银行',
'03270000':u'友利银行(中国)有限公司',
'04012900':u'上海银行',
'04031000':u'北京银行',
'04053910':u'福州商业银行',
'04062410':u'长春市商业银行',
'04073140':u'镇江市商业银行',
'04083320':u'宁波银行',
'04105840':u'平安银行',
'04115010':u'焦作市商业银行',
'04123330':u'温州银行',
'04135810':u'广州市商业银行',
'04145210':u'汉口银行',
'04162640':u'齐齐哈尔商业银行',
'04172210':u'盛京银行',
'04184930':u'洛阳银行',
'04192310':u'辽阳市商业银行',
'04202220':u'大连银行',
'04213050':u'苏州市商业银行',
'04221210':u'石家庄商业银行',
'04233310':u'杭州商业银行',
'04240001':u'南京银行',
'04256020':u'东莞市商业银行',
'04263380':u'金华商业银行',
'04270001':u'乌鲁木齐市商业银行',
'04283370':u'绍兴商业银行',
'04296510':u'成都商业银行',
'04302240':u'抚顺市商业银行',
'04325210':u'宜昌市商业银行',
'04332350':u'葫芦岛市商业银行',
'04341100':u'天津市商业银行',
'04341101':u'天津银行',
'04354910':u'郑州商业银行',
'04360010':u'宁夏银行',
'04375850':u'珠海市商业银行',
'04392270':u'锦州市商业银行',
'04403600':u'徽商银行',
'04416530':u'重庆市商业银行',
'04422610':u'哈尔滨银行',
'04437010':u'贵阳市商业银行',
'04447910':u'西安商业银行',
'04453020':u'无锡市商业银行',
'04462260':u'丹东市商业银行',
'04478210':u'兰州市商业银行',
'04484210':u'南昌商业银行',
'04491610':u'太原市商业银行',
'04504520':u'青岛商行',
'04512420':u'吉林市商业银行',
'04523060':u'南通商业银行',
'04544240':u'九江市商业银行',
'04562230':u'鞍山市商业银行',
'04588510':u'青海银行',
'04593450':u'台州市商业银行',
'04603110':u'盐城商行',
'04615510':u'长沙市商业银行',
'04634280':u'赣州银行股份有限公司',
'04643970':u'泉州市商业银行',
'04652280':u'营口市商业银行',
'04667310':u'昆明商业银行',
'04672290':u'阜新市商业银行',
'04703350':u'嘉兴市商业银行',
'04721460':u'廊坊银行',
'04733450':u'泰隆城市信用社',
'04741910':u'呼市商业银行',
'04753360':u'湖州市商业银行',
'04786110':u'南宁市商业银行',
'04791920':u'包头市商业银行',
'04803070':u'连云港市商业银行',
'04814650':u'威海商业银行',
'04836560':u'攀枝花市商业银行',
'04856590':u'绵阳市商业银行',
'04866570':u'泸州市商业银行',
'04871620':u'大同市商业银行',
'04885050':u'三门峡市商业银行',
'04895910':u'湛江市商业银行',
'04901380':u'张家口市商业银行股份有限公司',
'04916170':u'桂林市商业银行',
'04922690':u'大庆市商业银行',
'04933120':u'靖江市长江城市信用社',
'04943030':u'徐州市商业银行',
'04956140':u'柳州市商业银行',
'04966730':u'南充市商业银行',
'04974634':u'莱芜银行',
'04986580':u'德阳市商业银行',
'04991240':u'唐山市商业银行',
'05007020':u'六盘水商行',
'05027360':u'曲靖市商业银行',
'05031680':u'晋城商业银行',
'05056020':u'东莞商行',
'05063330':u'温州银行',
'05075210':u'汉口银行',
'05083000':u'江苏银行',
'05105840':u'平安银行股份有限公司',
'05121660':u'长治市商业银行',
'05131410':u'承德市商业银行',
'05154680':u'德州市商业银行',
'05167030':u'遵义市商业银行',
'05171270':u'邯郸市商业银行',
'05181810':u'运城市农村信用合作社联合社',
'05197117':u'安顺市商业银行',
'05213000':u'江苏银行',
'05238333':u'平凉市商业银行',
'05247410':u'玉溪市商业银行',
'05253450':u'浙江民泰商业银行',
'05264330':u'上饶市商业银行',
'05274550':u'东营市商业银行',
'05284630':u'泰安市商业银行',
'05295280':u'襄樊市商业银行股份有限公司',
'05303380':u'浙江稠州商业银行',
'05311930':u'乌海市商业银行',
'05332740':u'七台河市城市信用社',
'05342050':u'鄂尔多斯市商业银行股份有限公司',
'05354970':u'鹤壁市城市信用社股份有限公司',
'05365030':u'许昌市商业银行',
'05374610':u'济宁市商业银行',
'05392330':u'铁岭市商业银行股份有限公司',
'05406650':u'乐山市商业银行',
'05417930':u'宝鸡商行',
'05426900':u'重庆三峡银行',
'05438720':u'石嘴山银行',
'05442320':u'盘锦市商业银行',
'05478820':u'克拉玛依市商业银行',
'05484950':u'平顶山市商业银行',
'14012900':u'上海农信',
'14023052':u'昆山农信社',
'14030001':u'常熟市农村商业银行',
'14033055':u'常熟农村商业银行',
'14045840':u'深圳农信社',
'14055810':u'广州市农信社',
'14075882':u'佛山市南海区农信',
'14085883':u'顺德农信社',
'14097310':u'昆明农联社',
'14105200':u'湖北农信社',
'14105210':u'武汉农信',
'14113030':u'徐州市郊农村信用合作联社',
'14123020':u'江阴市农村商业银行',
'14123022':u'江阴农村商业银行',
'14136530':u'重庆农村商业银行股份有限公司',
'14144500':u'山东农村信用联合社',
'14156020':u'东莞农村信用合作社',
'14163056':u'张家港农村商业银行',
'14173900':u'福建省农村信用社联合社',
'14181000':u'北京农村商业银行',
'14191100':u'天津市农村信用社',
'14203320':u'鄞州农村合作银行',
'14203323':u'宁波鄞州农村合作银行',
'14215881':u'佛山市三水区农村信用合作社',
'14226510':u'成都农信社',
'14243000':u'江苏农信社',
'14255890':u'江门市新会区农村信用合作联社',
'14265930':u'肇庆农村信用社',
'14275880':u'佛山市禅城区农村信用联社',
'14283050':u'吴江农村商业银行',
'14293300':u'浙江省农村信用社联合社',
'14303050':u'江苏东吴农村商业银行',
'14315850':u'珠海农村信用合作社联社',
'14326030':u'中山市农村信用合作社',
'14333051':u'太仓农村商业银行',
'14341770':u'尧都区农村信用合作社联社',
'14353041':u'武进农村商业银行',
'14367000':u'贵州省农村信用社联合社',
'14373020':u'江苏锡州农村商业银行',
'14385500':u'湖南省农村信用社联合社',
'14394200':u'江西农信联合社',
'14404900':u'河南省农村信用社联合社',
'14411200':u'河北省农村信用社联合社',
'14427900':u'陕西省农村信用社联合社',
'14436100':u'广西农村信用社联合社',
'14448800':u'新疆维吾尔自治区农村信用社联合',
'14452400':u'吉林农信联合社',
'14468700':u'黄河农村商业银行',
'14473600':u'安徽省农村信用社联合社',
'14486400':u'海南省农村信用社联合社',
'14498500':u'青海省农村信用社联合社',
'14505800':u'广东省农村信用社联合社',
'14511900':u'内蒙古自治区农村信用社联合式',
'14526500':u'四川省农村信用社联合社',
'14538200':u'甘肃省农村信用社联合社',
'14542200':u'辽宁省农村信用社联合社',
'14561100':u'天津滨海农村商业银行',
'14572600':u'黑龙江省农村信用社联合社',
'15015363':u'湖北嘉鱼吴江村镇银行',
'15024521':u'青岛即墨北农商村镇银行',
'15025371':u'湖北仙桃北农商村镇银行',
'15036512':u'双流诚民村镇银行',
'15036753':u'宣汉诚民村镇银行',
}
class WebClient(http.Controller):
    @http.route("/web/api/99bill/mas/",type="http",auth="none")
    def get_mas(self,**kw):
        #{'cardType': u'0002',
        # 'RRN': u'001093037866',
        # 'amt': u'1.00',
        # 'authCode': u'',
        # 'issuerId': u'03080000',
        # 'responseMessage': u'\ufffd\ufffd\ufffd\u05f3\u0279\ufffd',
        # 'terminalId': u'35076467',
        # 'externalTraceNo': u'',
        # 'terminalOperId': u'001',
        # 'issuerIdView': u'\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd\ufffd',
        # 'txnTime': u'20150615 101913',
        # 'shortPAN': u'6225887199',
        # 'orgTxnType': u'',
        # 'orgExternalTraceNo': u'',
        # 'responseCode': u'00',
        # 'signature': u'GVyliBwvRk2LPmtN/XwuuQopHeWXywRlsdl93YHRdx/uIO2RfE1zRKD66s1rdV8dlUBQqoHNjc1Rqtyd0K5EZXsEjR/NQoDnzJEmDn+4IA0TpbYvQnrKBTsvudfAB7CJxJ3OXIR38RyaoyNf+A/MW5CdUdFV+ElmflAaFp8ddgY=',
        # 'merchantId': u'812430080710001',
        # 'processFlag': u'0',
        # 'txnType': u'RFD'}
        _logger.warn(kw)
        registry = RegistryManager.get(request.session.db)
        for i in range(0,len(kw.get("issuerIdView"))):
            _logger.warn(ord(kw.get("issuerIdView")[i]))
        with registry.cursor() as cr:
            obj = registry.get("rhwl.99bill.mas")
            val={
                "card_type":kw.get("cardType"),
                "rrn":kw.get("RRN"),
                "issuer_id":kw.get("issuerId"),
                "issuer_id_view":bank_name.get(kw.get("issuerId").encode('utf-8')),
                "response_code":kw.get("responseCode"),
                "response_message":u"交易正常完成",
                "terminal_id":kw.get("terminalId"),
                "terminal_oper_id":kw.get("terminalOperId"),
                "txn_time":kw.get("txnTime",""),
                "txntime":datetime.datetime.strptime(kw.get("txnTime","").encode('utf-8'),'%Y%m%d %H%M%S')+datetime.timedelta(hours=-8),
                "short_pan":kw.get("shortPAN"),
                "org_txn_type":kw.get("orgTxnType"),
                "org_external_trace_no":kw.get("orgExternalTraceNo"),
                "external_trace_no":kw.get("externalTraceNo",""),
                "amt":kw.get("amt",0),
                "process_flag":kw.get("processFlag",False),
                "merchant_id":kw.get("merchantId"),
                "process_flag":True if kw.get("processFlag")==u"0" else False,
                "txn_type":kw.get("txnType"),
                "signature":kw.get("signature"),
            }
            if val.get("response_code")==u"00":
                obj.create(cr,SUPERUSER_ID,val)
                cr.commit()
        return "0"